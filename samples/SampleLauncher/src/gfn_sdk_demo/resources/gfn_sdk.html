<html>
<head>
    <title>NVIDIA GeForce NOW SDK Sample</title>
    <style>
        body {
            left: 0;
            top: 0;
            width: 496px;
            height: 330px;
            background: #191919;
            margin: 0 !important;
            overflow: hidden;
            user-select: none;
        }

        .parent {
            padding: 8px;
        }

        .coverart {
            width: 480px;
            height: 270px;
        }

        .nv-button {
            background-color: #76b900;
            border: none;
            color: white;
            text-align: center;
            font-size: 14px;
            width: 122px;
            height: 48px;
            cursor: pointer;
        }

        .nv-chevron {
            height: 32px;
            width: 32px;
            font-weight: bolder;
            font-size: 24px;
            position: absolute;
            top: 119px;
            border-color: white;
            border-width: 1px;
            border-style: solid;
            box-shadow: 0 0 2px 1px rgb(0,0,0);
        }

        .nv-chevron-right-align {
            left: 456px;
        }

        .nv-button:not(:last-of-type) {
            margin-right: 8px;
        }

        .nv-button-disabled {
            background-color: #FFFFFFB3;
            border: none;
            color: white;
            text-align: center;
            font-size: 14px;
            width: 122px;
            height: 48px;
        }

        .nv-button-disabled:not(:last-of-type) {
            margin-right: 8px;
        }

        .spacer {
            flex-grow: 1;
        }

        .nv-container {
            margin-top: 8px;
            display: flex;
            flex-direction: row;
            color: white;
            font-size: 14px;
            font-family: Arial;
            align-items: center;
        }

        .input {
            width: 100px;
            height: 20px;
            margin: 0px 8px 0px 8px;
        }

        .text {
            margin: 0px 0px 0px 8px;
        }

        .status {
            color: #FFFFFFB3;
            background: #292929;
            border-color: #FFFFFFB3;
            flex: auto;
            height: 154px;
        }

        .inputFullWidth {
            width: 490px;
            height: 20px;
            margin: 0px 0px 0px 8px;
        }
    </style>
</head>
<body>
    <div class="parent">
        <div>
            <img id="cover-art" class="coverart" />
        </div>
        <div id="ip-address" class="nv-container" style="display: none">
            <span class="text">User's IP Address: </span><span class="text" id="ip-address-value"></span>
        </div>
        <div class="nv-container">
            <button class="nv-button-disabled" disabled id="nv-login" onclick="doLogin()">NVIDIA<br />LOGIN</button>
            <button class="nv-button-disabled" style="display:none" disabled id="nv-logout" onclick="doLogout()">NVIDIA<br />LOGOUT</button>
            <div class="spacer"></div>
            <button class="nv-button-disabled" disabled id="previous-game" onclick="nextGame(-1)">PREVIOUS GAME</button>
            <div class="spacer"></div>
            <button class="nv-button-disabled" disabled id="next-game" onclick="nextGame(1)">NEXT GAME</button>
            <button class="nv-button-disabled" disabled id="stream-action" onclick="performStreamAction()">START<br />STREAM</button>
        </div>
        <div id="login-panel" class="nv-container">
            <span>Launcher Token:</span><input id="launcherToken" type="text" class="inputFullWidth" size="32" />
            <div class="spacer"></div>
        </div>
        <div id="stream-status" class="nv-container">
            <span>Stream Status: </span><span class="text" id="stream-status-value">Init</span>
        </div>
        <div class="nv-container">
            <textarea class="status" id="status" readonly></textarea>
        </div>
    </div>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.494.0.min.js"></script>
    <script language="JavaScript">
        /**
         * The client ID is used for NVIDIA Identity Services API calls and authentication to
         * identify where the client calls originate from. The ID used here is only for the
         * purpose of this sample launcher app and can not be reused by your application.
         *
         * If your application will initiate logins to the various NVIDIA GFN infrastructure,
         * you must request your own client ID and make sure it is registered with the NVIDIA
         * Identity Services via your NVIDIA partner representative. Because of the sensitive
         * nature of authentication, the IdP APIs will not return user token data to any
         * application that does not have a valid registered client ID.
         */
        var sampleLauncherClientId = '93bvf7pvsTfhiYFLnlhE8-v07VlJRiDLGiJ94hgxenk';

        /**
        * The device ID is used by NVIDIA Identity Services API to identify the source of
        * the request. To be able to tell requests apart, tt should be unique per user device.
        */
        var sampleLauncherDeviceId = 'gfnsdksamplelauncherdeviceid';

        var launcherName = null;
        var launcherGameId = null;
        var gfnTitleId = null;
        var nvidiaToken = null;
        var oauthWindow = null;
        var userToken = null;
        var gameIndex = 0;
        var supportedTitlesAsJson = null;
        var preferredAuthType = 'AUTH_NVIDIA_DEFAULT';
        // These defines mirror the ones in GfnRuntimeSdk_CAPI.h
        var AUTH_NVIDIA_DEFAULT = '7';
        var streamRunning = false;

        /**
         * Adds a given input message to the console log as well as the log text box.
         * @param message Input string to be added to the log
         */
        function setStatus(message) {
            console.log(message);
            var timestamp = new Date();
            document.getElementById('status').innerHTML = '[' + timestamp.toLocaleTimeString() + '] ' + message + '\n' + document.getElementById('status').innerHTML;
        }

        /**
         * Initializes the NVIDIA GeForce NOW SDK and other startup values. Also checks
         * if the client is being run on a GeForce NOW game seat to show a different UI.
         */
        function initializeSdk() {
            return new Promise((resolve, reject) => {
                setStatus('Initializing GFN SDK');
                    window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_INIT'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        var success = data.success;
                        if (success) {
                            setStatus('GFN SDK successfully initialized!');
                            resolve(0);
                        } else {
                            setStatus('GFN SDK not initialized: ' + data.errorMessage);
                            reject(success);
                        }
                        resolve(0);
                    },
                    onFailure: function (error_code, error_message) {
                        setStatus('GFN SDK not initialized: ' + error_message);
                        reject(error_code);
                    }
                });
            });
        }

        /**
         * Requests a callback when the streamer state changes
         */
        function registerStreamStatusCallback() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_REGISTER_STREAM_STATUS_CALLBACK'
                }),
                persistent: true,
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('StreamStatus update: ' + data.status);
                    if (data.status == 'Init') {
                        streamRunning = true;
                        updateStreamButton();
                    }
                    if (data.status == 'Done' || data.status == 'Error') {
                        streamRunning = false;
                        updateStreamButton();
                    }

                    var streamStatusDiv = document.getElementById('stream-status');
                    var streamStatusValue = document.getElementById('stream-status-value');
                    streamStatusValue.innerHTML = data.status;
                }
            });
        }

        /**
         * Calls into GFN SDK to determine whether the sample launcher is being executed inside
         * an NVIDIA GeForce NOW game seat. If running in the cloud it exercises other GFN SDK
         * functions like displaying the user's current local IP address, or restoring the launcher
         * user session from the IDM to demonstrate Single Sign-On behavior.
         */
        function isRunningInCloud() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_RUNNING_IN_CLOUD'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus(data.enabled ? 'Client is running on a cloud GFN game seat' : 'Client is not running on a cloud GFN game seat');

                        if (data.enabled) {
                            // Get current client IP
                            getClientIp();
                            // Get current client country code
                            getClientCountryCode();
                            // Get streamable status about a specific title
                            isTitleAvailable();
                            // Get all titles available to stream in the current GFN game seat
                            getAvailableTitles();
                            // Obtain custom auth data that passed in as part of StartStream API
                            requestCustomAuthToken();
                        }
                        resolve(data.enabled);
                    }
                });
            });
        }

        function getAvailableTitles() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_GET_AVAILABLE_TITLES',
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus('Available titles result: ' + data.errorMessage);
                        setStatus('Available titles: ' + data.titles);
                    }
                });
            });
        }

        function isTitleAvailable() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_TITLE_AVAILABLE',
                        appId: "730",   // Use the ID of your specific title of your platform
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus(data.available ? 'Title is available to stream' : 'Title is not available to stream');
                        resolve(data.available);
                    }
                });
            });
        }

        function getSupportedTitles() {
            var url = 'https://prod.cloudmatchbeta.nvidiagrid.net/v2/serverInfo';
            return fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function (response) {
                if (!response.ok) {
                    throw 'The serverInfo endpoint failed';
                }
                return response.json();
            })
            .then(function (responseJson) {
                var serverId = responseJson.requestStatus.serverId;
                setStatus('serverId: ' + serverId);
                if(serverId === '') {
                    throw 'serverId value is not valid';
                }
                url = 'https://gfnpc.api.entitlement-prod.nvidiagrid.net/v2/apps?serviceName=gfn_pc&vpcId=' + serverId;
                return fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(function (response) {
                    if (!response.ok) {
                        throw 'The apps endpoint failed';
                    }
                    return response.json();
                })
                .then(function (responseJson) {
                    return responseJson.apps;
                })
            })
        }

        /**
         * Calls into GFN SDK to initiate a new GeForce NOW streaming session and launch the currently
         * selected game, or stop it if a stream is running.
         * 
         * If the authentication method is set to "NVIDIA Account" and a valid delegate token is passed
         * in as a parameter it will automatically authenticate the streaming session and begin streaming
         * immediately. If an empty or invalid delegate token is passed in then the GeForce NOW streaming
         * client will display a login window prompting the user to authenticate first.
         * If the user previously logged into their NVIDIA user account we request a new delegate
         * token to start streaming with, otherwise we pass an empty token and let the GeForce NOW
         * streaming client handle NVIDIA user authentication.
         * 
         * The serviceId and appId parameters should be obtained from an NVIDIA Developer Services
         * API call which returns that information, see the nextGame() function below for an example.
         */
        function performStreamAction() {
            if (streamRunning == false) {
                setStatus('Launching game stream session...');
                var authType = 0;
                var promise = Promise.resolve(null);
                promise.then(function () {
                    window.cefQuery({
                        request: JSON.stringify({
                            command: 'GFN_SDK_STREAM_ACTION',
                            gfnTitleId: gfnTitleId,                 // GFN ID for the title to stream
                            authToken: nvidiaToken,                 // NVIDIA IDM ID Token, the user has logged in via the UI
                            tokenType: AUTH_NVIDIA_DEFAULT,         // Type of authToken
                            launcherToken: document.getElementById('launcherToken').value,
                            launchStream: !streamRunning
                        }),
                        onSuccess: function (response) {
                            var data = JSON.parse(response);
                            setStatus('Game launched: ' + data.actionSuccess + ' (' + data.errorMessage + ')');
                        }
                    })
                });
            } else {
                setStatus('Stopping game stream session...');
                var promise = Promise.resolve(null)
                promise.then(function () {
                    window.cefQuery({
                        request: JSON.stringify({
                            command: 'GFN_SDK_STREAM_ACTION',
                            launchStream: !streamRunning
                        }),
                        onSuccess: function (response) {
                            var data = JSON.parse(response);
                            setStatus('Stream stop request: ' + data.actionSuccess + ' (' + data.errorMessage + ')');
                            streamRunning = false;
                            updateStreamButton();
                            var streamStatusValue = document.getElementById('stream-status-value');
                            streamStatusValue.innerHTML = "Stopped";
                        }
                    })
                });
            }
        }

        /**
         * Goes to the next or previous game in the list of games available for streaming on GeForce NOW
         * and calls the NVIDIA Developer Services API to retrieve game metadata required for launch
         * as well as information such as game name and a URL for the cover art image, which can be
         * requested in various available formats.
         * @param increment Number of steps by which to increase or decrease the current games index
         */
        function nextGame(increment) {
            gameIndex += increment;
            if (gameIndex < 0) {
                gameIndex = supportedTitlesAsJson.length - 1;
            }
            if (gameIndex >= supportedTitlesAsJson.length) {
                gameIndex = 0;
            }

            // Most partner applications will have their own artwork for their own dimension needs,
            // and thus, artwork URLs are not included in the /apps REST endpoint. For this
            // sample application, we utilize GFN artwork services. If you wish to utilize the
            // same services, contact NVIDIA for more information on doing so.
            var cover = document.getElementById('cover-art');

            cover.src = 'https://img.nvidiagrid.net/appimg/' + supportedTitlesAsJson[gameIndex].appId + '/ZZ/23';
            gfnTitleId = supportedTitlesAsJson[gameIndex].appId;
            var lastIndex = supportedTitlesAsJson.length - 1;
            setStatus('GFN Game ' + gameIndex + ' of ' + lastIndex + ':  ' + JSON.stringify(supportedTitlesAsJson[gameIndex]));
        }

        /**
         * Calls into GFN SDK to request a copy of the 3rd party user access token passed into the
         * StartStream API. This token should be a token that can be consumed by your application
         * that is running inside the GFN cloud environment to facilitate Single Sign-On (SSO) and
         * thus not require the user to manually log into your application.
         */
        function requestCustomAuthToken() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_REQUEST_ACCESS_TOKEN'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    launcherToken = data.authData;
                    setStatus('Custom auth token retrieval completed: ' + data.errorMessage + ', token: "' + launcherToken + '"');
                }
            });
        }

        /**
         * Calls into GFN SDK to get the user's current local IP address. This is meant to be
         * called while running on the GeForce NOW game seat to handle scenarios where the IP
         * addressed is used for account security or other validation purposes or things like
         * region specific localization or other UI.
         */
        function getClientIp() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_IP'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    clientIp = data.clientIp;
                    setStatus('Got client IP address: ' + clientIp + ' (' + data.errorMessage + ')');

                    var ipAddressDiv = document.getElementById('ip-address');
                    var ipAddressValue = document.getElementById('ip-address-value');
                    ipAddressValue.innerHTML = clientIp;
                    ipAddressDiv.style.display = 'flex';
                }
            });
        }

        /**
         * Calls into GFN SDK to get the user's current country code. This is meant to be
         * called while running on the GeForce NOW game seat to validation purposes or things like
         * region specific localization or other UI.
         */
        function getClientCountryCode() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_COUNTRY_CODE'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    clientCountryCode = data.clientCountryCode;
                    setStatus('Got client country code: ' + clientCountryCode + ' (' + data.errorMessage + ')');
                }
            });
        }

        /**
         * Opens a popup window that displays the NVIDIA Identity Services login website to
         * facilitate authentication with a new or existing NVIDIA account. This is part of
         * the Account Linking flow, or can be used as a one-time authentication operation.
         * After login is completed, the response and further calls are done through the
         * receiveMessage event handler.
         */
        function doLogin() {
            var popupX = 600,
                popupY = 224,
                popupWidth = 721,
                popupHeight = 760;

            setStatus('Opening oauth window for NVIDIA Account authentication...');
            if (oauthWindow === null) {
                window.addEventListener('message', receiveMessage);
            }
            if (oauthWindow !== null && !oauthWindow.closed) {
                oauthWindow.close();
            }

            window.cefQuery({
                request: JSON.stringify({
                    command: 'GET_TCP_PORT'
                }),
                onSuccess: function (response) {
                    var tcpPort = JSON.parse(response).port;
                    var nonce = 'gfnsdksamplelauncher_' + Math.random().toString(18).slice(2);
                    setStatus('login TCP Port: ' + tcpPort + ', nonce: ' + nonce);

                    oauthWindow = window.open('https://login.nvidia.com/authorize?' +
                        'response_type=id_token%20token&' +
                        'client_id=' + sampleLauncherClientId + '&' +
                        'redirect_uri=https%3A%2F%2Flocalhost%3A' + tcpPort + '%2Fredirect.html&' +
                        'scope=openid%20email%20preferred_username&' +
                        'device_id=' + sampleLauncherDeviceId + '&' +
                        'nonce=' + nonce,
                        'app_oauthWindow', 'toolbar=0,location=0,menubar=0,status=0,titlebar=0,' +
                        // Absolute coordinates that match the size/location of the underlying element
                        'left=' + popupX + ',top=' + popupY + ',width=' + popupWidth +
                        ',height=' + popupHeight);
                },
                onFailure: function (response) {
                    setStatus('Failed to get TCP port: ' + JSON.stringify(response));
                }
            });
        }

        /**
         *  Simulates logging out of the user's NVIDIA account.
         *  All we do in this case is forget the NVIDIA ID Token we have stored and continue as if we never had it
         *  In a real solution, this would likely involve asking an IDM backend to forget the link as well.
         */
        function doLogout() {
            nvidiaToken = null;
            document.getElementById('nv-login').style.display = '';
            document.getElementById('nv-logout').style.display = 'none';
            setStatus('Logged out from NVIDIA.');
        }

        /**
         * Helper method for base64 encoding a given input string. This is used to simulate
         * generation of an authentication token for the launcher IDM, which is then stored
         * as the Account Link information in the IDM hosted on AWS.
         * @param str Input string to be encoded as base64
         */
        function base64encode(str) {
            return window.btoa(window.unescape(window.encodeURIComponent(str)));
        }

        /**
         * Helper method for decoding a given base64 input string. This is used to simulate
         * the part of the Single Sign-On flow where we receive an encoded launcher user token
         * after validating the Account Link against the launcher IDM, and then use the
         * token to establish a valid launcher user session.
         * @param str Base64 encoded input string to be decoded
         */
        function base64decode(str) {
            return window.decodeURIComponent(window.atob(str));
        }

        /**
         * Event handler for window event messages. This is used to receive the authentication
         * token information from the NVIDIA Identitiy Services login popup window after
         * successful login. The login response provides an oauth code, which can be used to
         * obtain additional information such as the NVIDIA user ID, which in turn is used for
         * the delegate token request call.
         * @param event Window event that was sent to be handled
         */
        function receiveMessage(event) {
            // If the OAuth popup dialog isn't currently open then there is no work for us to do
            if (oauthWindow && !oauthWindow.closed) {
                oauthWindow.close();
                oauthWindow = null;
            }
            window.removeEventListener('message', receiveMessage);

            if (event.result != undefined) {
                setStatus('Event contains an error: ' + event.result);
                return;
            }
            if (!event.data) {
                setStatus('Unexpected event data detected.');
                return;
            }
            if (!event.data.idToken || event.data.idToken =='') {
                setStatus('ID token not defined in message.');
                return;
            }
            nvidiaToken = event.data.idToken;            
            setStatus('Succesfully retrieved NVIDIA ID token: ' + nvidiaToken);
            document.getElementById('nv-login').style.display = 'none';
            document.getElementById('nv-logout').style.display = '';
        }

        function enableButtons(enable) {
            if (enable) {
                document.getElementById('nv-login').setAttribute("class", 'nv-button');
                document.getElementById('nv-logout').setAttribute("class", 'nv-button');
                document.getElementById('next-game').setAttribute("class", 'nv-button');
                document.getElementById('previous-game').setAttribute("class", 'nv-button');
                document.getElementById('stream-action').setAttribute("class", 'nv-button');
            }
            else {
                document.getElementById('nv-login').setAttribute("class", 'nv-button-disabled');
                document.getElementById('nv-logout').setAttribute("class", 'nv-button-disabled');
                document.getElementById('next-game').setAttribute("class", 'nv-button-disabled');
                document.getElementById('previous-game').setAttribute("class", 'nv-button-disabled');
                document.getElementById('stream-action').setAttribute("class", 'nv-button-disabled');
            }

            document.getElementById('nv-login').disabled = !enable;
            document.getElementById('nv-logout').disabled = !enable;
            document.getElementById('next-game').disabled = !enable;
            document.getElementById('previous-game').disabled = !enable;
            document.getElementById('stream-action').disabled = !enable;
        }

        function updateStreamButton() {
            if (streamRunning == false) {
                document.getElementById('stream-action').innerHTML = 'START <br> STREAM';
            }
            else {
                document.getElementById('stream-action').innerHTML = 'STOP <br> STREAM';
            }
        }

        function surfaceDemoTitle() {
            // For simplicity of testing the SDK, make sure the Apollo 11 demo is first in the list
            var apollo11Index = null;
            supportedTitlesAsJson.find(function (entry, index) {
                if (entry.appId === 16032111) {
                    apollo11Index = index;
                }
            });
            if (apollo11Index) {
                supportedTitlesAsJson[0] = supportedTitlesAsJson.splice(apollo11Index, 1, supportedTitlesAsJson[0])[0];
            }
        }

        document.addEventListener("DOMContentLoaded", function (event) {
            initializeSdk().then(function () {
                // Check if we're running on the game seat to
                // decide if we should get the supported titles
                isRunningInCloud().then(function (isCloud) {
                    if (!isCloud) {
                        registerStreamStatusCallback();
                        getSupportedTitles().then(function (titles) {
                            supportedTitlesAsJson = titles;
                            surfaceDemoTitle();
                            nextGame(0);
                            enableButtons(true);
                        }, function (error) {
                            setStatus('getSupportedTitles failed with ' + error);
                        });
                    }
                    else {
                        setStatus('Running in GFN Cloud, skipping getting Supported Titles');
                    }
                });
            }, function (error) {
                setStatus('initializeSdk failed with ' + error);
            });
        });
    </script>
</body>
</html>
